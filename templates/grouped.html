{% extends "base.html" %}
{% block content %}
<div class="container">
  <div class="topbar">
    <div class="title">
      <span>åˆ†ç»„è§†å›¾</span>
      <small id="wellBadge"></small>
    </div>

    <div class="toolbar">
      <div class="field">
        <label>äº•å</label>
        <input id="wellInput" type="text" value="{{ well }}" placeholder="ä¾‹å¦‚ï¼šBZ8-3S-11">
        <button id="btnQuery" class="btn">æŸ¥è¯¢</button>
      </div>

      <div class="field">
        <label>æ ·å“ç±»å‹</label>
        <select id="sampleType"></select>
      </div>

      <div class="field">
        <label>ä»æ·±åº¦å¼€å§‹</label>
        <input id="startDepth" type="number" step="0.01" placeholder="ä¾‹å¦‚ 3650">
        <button id="btnPreset" class="btn secondary">é¢„æ’å½“å‰é¡µ</button>
      </div>

      <div class="field">
        <label>æ¯é¡µè¡Œæ•°</label>
        <input id="rowsPerPage" type="number" min="1" value="10" style="width:80px">
      </div>

      <div class="field" style="position:relative">
        <button id="btnCols" class="btn secondary">åˆ—æ˜¾ç¤º/éšè—</button>
        <div id="colsPanel" class="popover hidden"></div>
      </div>

      <div class="field">
        <label class="lock-label"><input type="checkbox" id="rowSeqLock" checked> è¡Œé¡ºåºé”ï¼ˆè§å…‰æ®µé€’å¢ï¼‰</label>
      </div>
    </div>
  </div>

  <div class="pager">
    <button id="prevPage" class="btn secondary">ä¸Šä¸€é¡µ</button>
    <span id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
    <button id="nextPage" class="btn secondary">ä¸‹ä¸€é¡µ</button>
  </div>

  <div id="tableWrapper" class="table-wrapper">
    <div id="table" class="grid"></div>
  </div>
</div>

<!-- é”æç¤ºï¼ˆä»…é  .hidden æ§åˆ¶æ˜¾éšï¼‰ -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <div id="modalMsg" class="modal-msg"></div>
    <div class="modal-actions">
      <button id="modalFix" class="btn">è‡ªåŠ¨è°ƒæ•´</button>
      <button id="modalOnce" class="btn secondary">å¿½ç•¥ä¸€æ¬¡</button>
      <button id="modalUnlock" class="btn danger">å…³é—­è¯¥é”</button>
    </div>
  </div>
</div>

<!-- äº•å·å€™é€‰ï¼ˆä»…é  .hidden æ§åˆ¶æ˜¾éšï¼‰ -->
<div id="wellPicker" class="modal hidden">
  <div class="modal-card">
    <div class="modal-msg">åŒ¹é…åˆ°å¤šå£äº•ï¼Œè¯·é€‰æ‹©ï¼š</div>
    <div id="wellList" class="well-list"></div>
    <div class="modal-actions">
      <button id="wellCancel" class="btn secondary">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- å¤§å›¾é¢„è§ˆï¼ˆLightboxï¼‰ -->
<div id="zoomModal" class="zoom hidden" tabindex="-1" aria-hidden="true">
  <div class="zoom-backdrop"></div>
  <div class="zoom-box">
    <img id="zoomImg" alt="é¢„è§ˆ">
    <button id="zoomClose" class="zoom-close" title="å…³é—­">Ã—</button>
  </div>
</div>

<!-- åŠ è½½ä¸­é®ç½© -->
<div id="loading" class="loading hidden">
  <div class="spinner"></div>
  <div class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®â€¦</div>
</div>

<script>
/* ===================== å°å·¥å…· ===================== */
function el(tag, attrs={}, kids=[]) {
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') e.className = v;
    else if (k === 'html') e.innerHTML = v;
    else e.setAttribute(k, v);
  }
  (Array.isArray(kids) ? kids : [kids]).forEach(c => e.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
  return e;
}
const fmtDepth = (s,e)=> (s==null||e==null) ? "â€”" : (Math.abs(s-e)<1e-6 ? `${s.toFixed(2)} m` : `${s.toFixed(2)}â€“${e.toFixed(2)} m`);

function showLoading(on) {
  document.getElementById('loading').classList.toggle('hidden', !on);
}
function toast(msg){ alert(msg); }

// é¢„è§ˆå›¾ URLï¼ˆèµ° /preview/{max}/{rel_path}ï¼‰
function getRelPath(obj) {
  if (!obj) return '';
  if (obj.rel_path) return obj.rel_path;
  if (obj.file_url && obj.file_url.startsWith('/files/')) {
    const raw = obj.file_url.slice('/files/'.length);
    try { return decodeURIComponent(raw); } catch { return raw; }
  }
  return '';
}
function previewUrl(obj, maxSide) {
  const rel = getRelPath(obj);
  const enc = rel.split('/').map(encodeURIComponent).join('/');
  return `/preview/${maxSide}/${enc}`;
}

/* ===================== å…¨å±€çŠ¶æ€ ===================== */
const state = {
  data: null,
  visibleCats: new Set(),
  colLocks: {},
  rowSegIdx: [],
  cellSel: {},
  page: 1,
  pageSize: 10,
  modal: { resolver: null, context: null },
  catsAll: ["è§å…‰æ‰«æ","å•åå…‰","æ­£äº¤å…‰","ä¸‰ç»´æŒ‡çº¹","ä¸‰ç»´ç«‹ä½“","è‰²è°±","è½»çƒƒè°±å›¾"],
};

/* ===================== å…ˆâ€œè§£æäº•å·â€å†åŠ è½½æ•°æ® ===================== */
async function resolveWellAndLoad(){
  const input = document.getElementById('wellInput').value.trim();
  if (!input) { toast('è¯·å…ˆè¾“å…¥äº•å'); return; }

  showLoading(true);
  try {
    const res = await fetch('/api/wells?q=' + encodeURIComponent(input));
    const data = await res.json();
    showLoading(false);

    const cands = Array.isArray(data.candidates) ? data.candidates : [];
    if (cands.length === 0) {
      toast('æ²¡æœ‰åŒ¹é…åˆ°äº•å·'); return;
    }

    // åªæœ‰â€œå”¯ä¸€å€™é€‰ä¸”ä¸è¾“å…¥ç²¾ç¡®ï¼ˆå¿½ç•¥ç©ºæ ¼/å¤§å°å†™ï¼‰ä¸€è‡´â€æ—¶ï¼Œç›´æ¥åŠ è½½ï¼›å…¶ä»–æƒ…å†µä¸€å¾‹å¼¹çª—
    const eq = (a,b)=> a.replace(/\s+/g,'').toLowerCase() === b.replace(/\s+/g,'').toLowerCase();
    const exactOne = (cands.length === 1) && data.resolved && eq(cands[0], input);

    if (exactOne) {
      document.getElementById('wellInput').value = data.resolved;
      await populateSampleTypes(data.resolved);  // â† æ–°å¢
      await loadData();
      return;
    }
    showWellPicker(cands);

  } catch (e) {
    showLoading(false);
    console.error(e);
    toast('äº•å·è§£æå¤±è´¥');
  }
}

async function populateSampleTypes(well) {
  const sel = document.getElementById('sampleType');
  const keep = sel.value; // è®°ä½å½“å‰é€‰æ‹©ï¼Œä¾¿äºåˆ·æ–°åä¿æŒ
  sel.innerHTML = '';     // æ¸…ç©º

  // å…ˆæ”¾â€œå…¨éƒ¨â€
  const optAll = document.createElement('option');
  optAll.value = '';
  optAll.textContent = 'å…¨éƒ¨';
  sel.appendChild(optAll);

  try {
    const url = new URL('/api/sample-types', window.location.origin);
    if (well) url.searchParams.set('well', well);
    const res = await fetch(url.toString());
    const data = await res.json();
    const types = Array.isArray(data.sample_types) ? data.sample_types : [];

    types.forEach(t => {
      const op = document.createElement('option');
      op.value = t;
      op.textContent = t;
      sel.appendChild(op);
    });

    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆè‹¥è¿˜å­˜åœ¨ï¼‰ï¼›å¦åˆ™é»˜è®¤â€œå…¨éƒ¨â€
    if ([...sel.options].some(o => o.value === keep)) {
      sel.value = keep;
    } else {
      sel.value = '';
    }
  } catch (e) {
    console.error('åŠ è½½æ ·å“ç±»å‹å¤±è´¥', e);
    // å¤±è´¥ä¹Ÿè‡³å°‘ä¿è¯æœ‰â€œå…¨éƒ¨â€
    sel.value = '';
  }
}

function showWellPicker(list) {
  const modal = document.getElementById('wellPicker');
  const cont  = document.getElementById('wellList');
  cont.innerHTML = '';
  list.forEach(w=>{
    const item = el('button',{class:'well-item'}, w);
    item.addEventListener('click', async ()=>{
      document.getElementById('wellInput').value = w;
      hideWellPicker();
      showLoading(true);
      await populateSampleTypes(w);
      await loadData();
      showLoading(false);
    });
    cont.appendChild(item);
  });
  modal.classList.remove('hidden');      // ç»Ÿä¸€ç”¨ç±»æ§åˆ¶
}
function hideWellPicker(){
  document.getElementById('wellPicker').classList.add('hidden');
}
document.getElementById('wellCancel').addEventListener('click', hideWellPicker);

/* ===================== æ•°æ®åŠ è½½ ===================== */
async function loadData() {
  const well = document.getElementById('wellInput').value.trim();
  const st   = document.getElementById('sampleType').value.trim();
  const url = new URL('/api/grouped-data', window.location.origin);
  if (well) url.searchParams.set('well', well);
  if (st)   url.searchParams.set('sample_type', st);

  showLoading(true);
  const res = await fetch(url.toString());
  const data = await res.json();
  showLoading(false);

  state.data = data;
  document.getElementById('wellBadge').textContent = data.well ? `ï¼ˆ${data.well}ï¼‰` : '';

  state.visibleCats = new Set(state.catsAll);
  state.colLocks = {};
  state.catsAll.forEach(c => state.colLocks[c] = false);

  state.page = 1;
  state.pageSize = parseInt(document.getElementById('rowsPerPage').value || '10', 10);

  const n = Math.min(state.pageSize, data.segments.length);
  state.rowSegIdx = Array.from({length: n}, (_,i)=> i);
  state.cellSel = {};

  buildColsPanel();
  render();
}

/* ===================== åˆ—æ˜¾ç¤º/éšè—é¢æ¿ ===================== */
function buildColsPanel() {
  const pan = document.getElementById('colsPanel');
  pan.innerHTML = "";
  pan.appendChild(el('div',{class:'popover-title'},'æ˜¾ç¤ºçš„åˆ—ï¼ˆè§å…‰åˆ—å§‹ç»ˆæ˜¾ç¤ºï¼‰'));

  const wrap = el('div',{class:'cols-wrap'});
  state.catsAll.filter(c=>c!=="è§å…‰æ‰«æ").forEach(cat => {
    const id = 'col_'+cat;
    const chk = el('input',{type:'checkbox', id, checked: state.visibleCats.has(cat)});
    chk.addEventListener('change', ()=>{
      if (chk.checked) state.visibleCats.add(cat); else state.visibleCats.delete(cat);
      renderTable();
    });
    const lab = el('label',{for:id},cat);
    wrap.appendChild(el('div',{class:'col-item'},[chk, lab]));
  });
  pan.appendChild(wrap);
}
document.getElementById('btnCols').addEventListener('click', ()=>{
  document.getElementById('colsPanel').classList.toggle('hidden');
});
document.addEventListener('click', (e)=>{
  const btn = document.getElementById('btnCols');
  const pan = document.getElementById('colsPanel');
  if (!btn.contains(e.target) && !pan.contains(e.target)) pan.classList.add('hidden');
});

/* ===================== æ¸²æŸ“å…¥å£ ===================== */
function render() {
  updatePager();
  renderTable();
}

/* ===================== åˆ†é¡µ ===================== */
function updatePager() {
  const totalRows = state.data ? state.data.segments.length : 0;
  const totalPages = Math.max(1, Math.ceil(totalRows / state.pageSize));
  state.page = Math.min(state.page, totalPages);
  document.getElementById('pageInfo').textContent = `ç¬¬ ${state.page} / ${totalPages} é¡µ`;
  document.getElementById('prevPage').disabled = state.page<=1;
  document.getElementById('nextPage').disabled = state.page>=totalPages;
}
document.getElementById('prevPage').addEventListener('click', ()=>{
  if (state.page<=1) return;
  state.page--;
  const start = (state.page-1)*state.pageSize;
  const n = Math.min(state.pageSize, state.data.segments.length - start);
  state.rowSegIdx = Array.from({length:n}, (_,i)=> start+i);
  state.cellSel = {};
  render();
});
document.getElementById('nextPage').addEventListener('click', ()=>{
  const totalRows = state.data.segments.length;
  const totalPages = Math.max(1, Math.ceil(totalRows/state.pageSize));
  if (state.page>=totalPages) return;
  state.page++;
  const start = (state.page-1)*state.pageSize;
  const n = Math.min(state.pageSize, totalRows - start);
  state.rowSegIdx = Array.from({length:n}, (_,i)=> start+i);
  state.cellSel = {};
  render();
});
document.getElementById('rowsPerPage').addEventListener('change', ()=>{
  const v = parseInt(document.getElementById('rowsPerPage').value||'10',10);
  state.pageSize = Math.max(1, v);
  state.page = 1;
  const n = Math.min(state.pageSize, state.data.segments.length);
  state.rowSegIdx = Array.from({length:n}, (_,i)=> i);
  state.cellSel = {};
  render();
});

/* ===================== é¢„æ’ï¼šä»æŸæ·±åº¦å¼€å§‹ ===================== */
document.getElementById('btnPreset').addEventListener('click', ()=>{
  const val = parseFloat(document.getElementById('startDepth').value);
  if (!state.data || !isFinite(val)) return;
  const idx = state.data.segments.findIndex(s => (s.center!=null && s.center>=val));
  const start = idx>=0 ? idx : state.data.segments.length-1;
  const n = Math.min(state.pageSize, state.data.segments.length - start);
  state.rowSegIdx = Array.from({length:n}, (_,i)=> start+i);
  state.cellSel = {};
  render();
});

/* ===================== è¡¨æ ¼æ¸²æŸ“ ===================== */
function renderTable() {
  const table = document.getElementById('table');
  table.innerHTML = '';
  if (!state.data) return;

  const start = (state.page-1)*state.pageSize;
  const end   = Math.min(state.data.segments.length, start + state.pageSize);
  const rowsN = state.rowSegIdx.length = Math.max(0, end - start);

  const cats = ["è§å…‰æ‰«æ", ...state.catsAll.filter(c=>c!=="è§å…‰æ‰«æ" && state.visibleCats.has(c))];
  const gridCols = cats.map((_,i)=> i===0 ? '220px' : '180px').join(' ');
  table.style.gridTemplateColumns = gridCols;

  // é”ï¼ˆåªæ”¹ stateï¼‰
  if (document.getElementById('rowSeqLock').checked) enforceRowLock();
  cats.forEach(cat=>{ if (cat!=="è§å…‰æ‰«æ" && state.colLocks[cat]) enforceColLock(cat); });

  // è¡¨å¤´
  cats.forEach(cat=>{
    const head = el('div',{class:'cell head'}, cat);
    if (cat!=="è§å…‰æ‰«æ") {
      const btn = el('button',{class:'lock-btn', title:'é¡ºåºé”ï¼šæœ¬åˆ—æ·±åº¦è‡ªä¸Šè€Œä¸‹ä¸å€’é€€'}, state.colLocks[cat]?'ğŸ”’':'ğŸ”“');
      btn.addEventListener('click', ()=>{
        state.colLocks[cat] = !state.colLocks[cat];
        btn.textContent = state.colLocks[cat]?'ğŸ”’':'ğŸ”“';
        renderTable();
      });
      head.appendChild(btn);
    }
    table.appendChild(head);
  });

  // è¡Œ
  for (let r=0; r<rowsN; r++) {
    if (state.rowSegIdx[r]==null) state.rowSegIdx[r]=start+r;
    const segIdx = state.rowSegIdx[r];
    cats.forEach(cat=>{
      if (cat==="è§å…‰æ‰«æ") table.appendChild(cellFluo(r, segIdx));
      else table.appendChild(cellCategory(r, segIdx, cat));
    });
  }
}

/* ========== å•å…ƒæ ¼ï¼šè§å…‰ï¼ˆè¡Œä¸»æ§ï¼‰ ========== */
function cellFluo(row, segIdx) {
  const seg = state.data.segments[segIdx];
  const cell = el('div',{class:'cell'});
  const fig  = el('div',{class:'thumb'});

  const pack = (state.data.imagesBySegment[seg.id]||{})["è§å…‰æ‰«æ"] || [];
  const cur  = pack[0];

  if (cur) {
    const im = el('img',{src: previewUrl(cur, 200), alt: 'è§å…‰æ‰«æ', loading:'lazy', decoding:'async'});
    im.addEventListener('click', ()=> showZoom(cur));
    fig.appendChild(im);
  } else {
    fig.appendChild(el('div',{class:'noimg'},'â€”'));
  }

  const sel = el('select',{class:'depth-select'});
  state.data.segments.forEach((s, i)=>{
    const op = el('option',{value:String(i)}, s.label);
    if (i===segIdx) op.selected = true;
    sel.appendChild(op);
  });
  sel.addEventListener('change', async ()=>{
    const newIdx = parseInt(sel.value,10);
    if (document.getElementById('rowSeqLock').checked) {
      const prevIdx = (row>0) ? state.rowSegIdx[row-1] : null;
      if (prevIdx!=null && newIdx < prevIdx) {
        const action = await confirmLock(
          `å½“å‰è¡Œæ·±åº¦æ®µæ¯”ä¸Šä¸€è¡Œæ›´æµ…ã€‚\næ˜¯å¦è‡ªåŠ¨è°ƒæ•´ä¸ºä¸å€’é€€çš„æœ€è¿‘æ·±åº¦æ®µï¼Ÿ`,
          { scope:'row' }
        );
        if (action === 'fix') {
          let cand = newIdx;
          if (newIdx < prevIdx) cand = prevIdx;
          state.rowSegIdx[row] = cand;
          sel.value = String(cand);
        } else if (action === 'once') {
          state.rowSegIdx[row] = newIdx;
        } else if (action === 'unlock') {
          document.getElementById('rowSeqLock').checked = false;
          state.rowSegIdx[row] = newIdx;
        }
      } else {
        state.rowSegIdx[row] = newIdx;
      }
    } else {
      state.rowSegIdx[row] = newIdx;
    }
    renderTable();
  });

  fig.appendChild(sel);  // è§å…‰åˆ—ï¼šåªæ˜¾ç¤ºä¸‹æ‹‰ï¼Œä¸å†é‡å¤æ·±åº¦æ–‡å­—
  cell.appendChild(fig);
  return cell;
}

/* ========== å•å…ƒæ ¼ï¼šå…¶ä»–ç±»åˆ«ï¼ˆæ®µå†…å€™é€‰ï¼‰ ========== */
function cellCategory(row, segIdx, cat) {
  const seg = state.data.segments[segIdx];
  const pack = (state.data.imagesBySegment[seg.id]||{})[cat] || [];
  const cell = el('div',{class:'cell'});
  const fig  = el('div',{class:'thumb'});

  if (!state.cellSel[row]) state.cellSel[row] = {};
  if (state.cellSel[row][cat]==null) state.cellSel[row][cat]=0;

  if (!pack.length) {
    fig.appendChild(el('div',{class:'noimg'},'â€”'));
    cell.appendChild(fig);
    return cell;
  }

  const pick = Math.min(state.cellSel[row][cat], pack.length-1);
  const cur  = pack[pick];

  const im = el('img',{src: previewUrl(cur, 180), alt: cat, loading:'lazy', decoding:'async'});
  im.addEventListener('click', ()=> showZoom(cur));
  fig.appendChild(im);

  if (pack.length > 1) {
    // å¤šå¼ ï¼šåªæ˜¾ç¤ºä¸‹æ‹‰ï¼ˆä¸æ˜¾ç¤ºæ·±åº¦æ–‡å­—ï¼‰ï¼Œå¹¶åŠ  xN å¾½æ ‡
    const sel = el('select',{class:'depth-select'});
    pack.forEach((it,k)=>{
      const op = el('option',{value:String(k)}, it.depth_label || 'â€”');
      if (k===pick) op.selected = true;
      sel.appendChild(op);
    });
    sel.addEventListener('change', async ()=>{
      const newIdx = parseInt(sel.value,10);
      if (state.colLocks[cat]) {
        const prevCenter = getPrevCenter(row, cat);
        const newCenter  = pack[newIdx]?.center ?? null;
        if (prevCenter!=null && newCenter!=null && newCenter < prevCenter) {
          const action = await confirmLock(
            `æœ¬åˆ—é€‰æ‹©çš„æ·±åº¦å°äºä¸Šä¸€è¡Œï¼Œå¯èƒ½é€ æˆâ€œå€’é€€â€ã€‚\néœ€è¦æˆ‘å¸®ä½ è‡ªåŠ¨é€‰æ‹©ä¸å€’é€€çš„æœ€è¿‘ä¸€å¼ å—ï¼Ÿ`,
            { scope:'col', cat }
          );
          if (action === 'fix') {
            let cand = newIdx, best = null;
            pack.forEach((it,k)=>{
              if (it.center!=null && it.center>=prevCenter) {
                const diff = Math.abs(it.center - prevCenter);
                if (best==null || diff<best.diff) best = {k, diff};
              }
            });
            if (best) cand = best.k;
            state.cellSel[row][cat] = cand;
            renderTable();
            return;
          } else if (action === 'unlock') {
            state.colLocks[cat] = false;
          }
        }
      }
      state.cellSel[row][cat] = newIdx;
      renderTable();
    });
    fig.appendChild(sel);
    fig.appendChild(el('div',{class:'badge'}, `Ã—${pack.length}`));
  } else {
    // å•å¼ ï¼šåªæ˜¾ç¤ºæ·±åº¦æ–‡å­—ï¼ˆä¸æ˜¾ç¤ºä¸‹æ‹‰ï¼‰
    fig.appendChild(el('div',{class:'caption small'}, cur.depth_label || 'â€”'));
  }

  cell.appendChild(fig);
  return cell;
}

/* ========== æ”¯æ’‘å‡½æ•°ï¼ˆé”ã€å¼¹çª—ã€é¢„è§ˆï¼‰ ========== */
function getPrevCenter(row, cat) {
  for (let r=row-1; r>=0; r--) {
    const segIdx = state.rowSegIdx[r];
    const seg = state.data.segments[segIdx];
    const pack = (state.data.imagesBySegment[seg.id]||{})[cat] || [];
    const idx  = state.cellSel[r]?.[cat] ?? 0;
    const it   = pack[Math.min(idx, pack.length-1)];
    if (it && it.center!=null) return it.center;
  }
  return null;
}
function enforceRowLock() {
  for (let r=1; r<state.rowSegIdx.length; r++) {
    if (state.rowSegIdx[r] < state.rowSegIdx[r-1]) state.rowSegIdx[r] = state.rowSegIdx[r-1];
  }
}
function enforceColLock(cat) {
  for (let r=0; r<state.rowSegIdx.length; r++) {
    const prev = getPrevCenter(r, cat);
    if (prev==null) continue;
    const segIdx = state.rowSegIdx[r];
    const seg = state.data.segments[segIdx];
    const pack = (state.data.imagesBySegment[seg.id]||{})[cat] || [];
    if (!pack.length) continue;

    let idx = state.cellSel[r]?.[cat] ?? 0;
    let it  = pack[Math.min(idx, pack.length-1)];
    if (!it || it.center==null || it.center < prev) {
      let best = null;
      pack.forEach((x,k)=>{
        if (x.center!=null && x.center>=prev) {
          const diff = Math.abs(x.center - prev);
          if (best==null || diff<best.diff) best = {k, diff};
        }
      });
      if (best) {
        if (!state.cellSel[r]) state.cellSel[r]={};
        state.cellSel[r][cat] = best.k;
      }
    }
  }
}
function confirmLock(message, ctx) {
  return new Promise(resolve=>{
    const modal = document.getElementById('modal');
    document.getElementById('modalMsg').textContent = message;
    modal.classList.remove('hidden');   // ç»Ÿä¸€ç”¨ç±»æ§åˆ¶
    state.modal.resolver = (v)=>{ modal.classList.add('hidden'); resolve(v); };
    state.modal.context  = ctx;
  });
}
document.getElementById('modalFix').addEventListener('click', ()=> state.modal.resolver && state.modal.resolver('fix'));
document.getElementById('modalOnce').addEventListener('click',()=> state.modal.resolver && state.modal.resolver('once'));
document.getElementById('modalUnlock').addEventListener('click',()=> state.modal.resolver && state.modal.resolver('unlock'));

const zoom = document.getElementById('zoomModal');
const zoomImg = document.getElementById('zoomImg');
const zoomClose = document.getElementById('zoomClose');
function showZoom(item){
  zoomImg.src = previewUrl(item, 1200);
  zoom.classList.remove('hidden');
  zoom.focus();
}
function hideZoom(){
  zoom.classList.add('hidden');
  zoomImg.src = '';
}
zoomClose.addEventListener('click', hideZoom);
zoom.addEventListener('click', (e)=>{ if (e.target===zoom || e.target.classList.contains('zoom-backdrop')) hideZoom(); });
document.addEventListener('keydown', (e)=>{ if (!zoom.classList.contains('hidden') && e.key==='Escape') hideZoom(); });

/* ===================== äº‹ä»¶ç»‘å®š ===================== */
document.getElementById('btnQuery').addEventListener('click', resolveWellAndLoad);
document.getElementById('wellInput').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') resolveWellAndLoad(); });
document.getElementById('sampleType').addEventListener('change', loadData);

/* é¦–æ¬¡ï¼šå¦‚æœæ¨¡æ¿é‡Œå·²æœ‰ç²¾ç¡® wellï¼Œå°±å…ˆæ‹‰æ ·å“ç±»å‹å†åŠ è½½æ•°æ® */
{% if well %}
(async ()=>{
  await populateSampleTypes("{{ well }}");
  await loadData();
})();
{% endif %}

</script>

<style>
:root{
  --bg:#0b1020; --card:#1f2633; --line:#2a3650; --text:#dbe2f7; --muted:#8ea2d6;
  --accent:#2f6fed; --accent2:#2a3650; --danger:#d84e53;
}
.container { max-width: min(1600px, 100vw - 32px); margin: 0 auto; padding: 0 16px; }
.topbar{display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin:16px 0;}
.title{font-size:22px; font-weight:700;}
.title small{font-weight:500; color:var(--muted); margin-left:6px;}
.toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
.field{display:flex; align-items:center; gap:8px;}
.btn{padding:6px 12px; border-radius:8px; background:var(--accent); color:#fff; border:0; cursor:pointer;}
.btn.secondary{background:var(--accent2);}
.btn.danger{background:var(--danger);}
input[type="text"], input[type="number"], select.depth-select, #sampleType{
  padding:6px 8px; border-radius:8px; background:#0f1420; color:var(--text); border:1px solid var(--line);
}
.pager{display:flex; align-items:center; gap:12px; margin:8px 0;}
.table-wrapper { position: relative; }
.table-wrapper::after{
  content:""; position: absolute; top:0; right:0; width:18px; height:100%;
  pointer-events:none; background: linear-gradient(to right, rgba(11,16,32,0), rgba(11,16,32,1));
}

.grid{display:grid; gap:8px;}
.cell{
  background:#0f1420; border:1px solid var(--line); border-radius:10px; padding:8px; min-height:152px;
  display:flex; align-items:center; justify-content:center; box-sizing:border-box; position:relative;
}
.cell.head{background:#0b1020; font-weight:600; position:sticky; top:0; z-index:5;}
.lock-btn{position:absolute; right:8px; top:6px; background:transparent; border:0; cursor:pointer; font-size:16px; color:var(--text);}
.thumb{
  width: 160px; height: 140px; overflow:hidden; border-radius:10px; position:relative;
  display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px;
}
.thumb img{max-width:100%; max-height:100%; object-fit:contain; display:block; border-radius:8px;}
.noimg{color:#5f6c8f;}
.badge{
  position: absolute;
  top: 6px;           /* â† ä»é¡¶éƒ¨æ˜¾ç¤º */
  right: 6px;
  bottom: auto;       /* å–æ¶ˆåº•éƒ¨å®šä½ */
  left: auto;
  background: rgba(0,0,0,.55);
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 12px;
  color: #fff;
  z-index: 2;
  pointer-events: none; /* é˜²æ­¢æŒ¡ç‚¹å‡»/æ‹–åŠ¨ */
}
.caption{font-size:12px; color:#c6d2f5;}
.caption.small{font-size:12px; color:#c6d2f5;}
.depth-select{width:100%;  position: relative; z-index: 1; }
.popover{position:absolute; margin-top:8px; background:#0f1420; border:1px solid var(--line); border-radius:10px; padding:12px; z-index:10; min-width:220px;}
.popover.hidden{display:none;}
.popover-title{font-weight:600; margin-bottom:8px;}
.cols-wrap{display:grid; grid-template-columns: repeat(2, 1fr); gap:8px;}
.col-item{display:flex; align-items:center; gap:8px;}
.lock-label{user-select:none;}

/* äº•å·å€™é€‰åˆ—è¡¨ */
.well-list{display:flex; flex-direction:column; gap:8px; margin:8px 0 12px;}
.well-item{padding:8px 10px; border-radius:8px; border:1px solid var(--line); background:#0f1420; color:var(--text); cursor:pointer; text-align:left;}
.well-item:hover{border-color:#4a6cf3;}

/* å¤§å›¾é¢„è§ˆï¼šæé«˜å±‚çº§ï¼Œé¿å…è¢«è¡¨å¤´ç›–ä½ */
.zoom{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:5000;}
.zoom.hidden{display:none;}
.zoom-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.72);}
.zoom-box{position:relative; z-index:2; max-width:92vw; max-height:92vh; display:flex; align-items:center; justify-content:center;}
#zoomImg{max-width:92vw; max-height:92vh; object-fit:contain; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5);}
.zoom-close{
  position:absolute; top:-10px; right:-10px; width:36px; height:36px; border-radius:50%;
  border:1px solid var(--line); background:#1b2335; color:#fff; font-size:20px; cursor:pointer;
}

/* åŠ è½½ä¸­é®ç½© */
.loading{position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; background:rgba(0,0,0,.35); z-index:4000;}
.loading.hidden{display:none;}
.spinner{width:42px; height:42px; border-radius:50%; border:4px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite;}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text{color:#fff; font-size:14px;}

/* === è¡¥å›é€šç”¨å¼¹çª—æ ·å¼ï¼ˆå…³é”®ï¼‰ === */
.modal{
  position: fixed;
  inset: 0;
  display: flex;                 /* å¼¹çª—å±…ä¸­ */
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.45);   /* èƒŒæ™¯é®ç½© */
  z-index: 4500;                 /* ç›–ä½è¡¨å¤´ç­‰ */
}
.modal.hidden{ display: none; }

.modal-card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 18px;
  width: 420px;
  max-width: calc(100vw - 32px);
}
.modal-msg{ white-space: pre-line; margin-bottom: 12px; color: var(--text); }
.modal-actions{ display: flex; gap: 8px; justify-content: flex-end; }

</style>

{% endblock %}
